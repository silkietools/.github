name: Security Baseline Enforcer

on:
  workflow_dispatch:
    inputs:
      org:
        description: "Organization login to enforce"
        required: false
        default: "silkietools"
      visibility:
        description: "Repos to target (public/private/all)"
        required: false
        default: "all"
  schedule:
    - cron: "29 6 * * 1"

permissions:
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run unit tests
        run: python3 -m unittest discover -s scripts/tests -p "test_*.py"

      - name: Resolve token
        run: |
          if [ -z "${{ secrets.ORG_ADMIN_TOKEN }}" ]; then
            echo "ORG_ADMIN_TOKEN is required for cross-repository security enforcement." >&2
            exit 1
          fi
          echo "GH_TOKEN=${{ secrets.ORG_ADMIN_TOKEN }}" >> "$GITHUB_ENV"

      - name: Enforce security baseline
        run: |
          ORG_INPUT="${{ github.event.inputs.org }}"
          if [ -z "${ORG_INPUT}" ]; then
            ORG_INPUT="${{ github.repository_owner }}"
          fi

          VIS_INPUT="${{ github.event.inputs.visibility }}"
          if [ -z "${VIS_INPUT}" ]; then
            VIS_INPUT="all"
          fi

          python3 scripts/enforce_security_baseline.py \
            --org "${ORG_INPUT}" \
            --visibility "${VIS_INPUT}" \
            --exclude ".github" \
            --output-json security-baseline-report.json \
            --strict

      - name: Upload enforcement artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-baseline-report
          path: security-baseline-report.json
